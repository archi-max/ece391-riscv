name: "Setup RISC-V toolchain (Ubuntu)"
description: "Installs RISC-V toolchain + exports bundled compat headers."
inputs:
  apt-cache:
    description: "Cache APT downloads"
    required: false
    default: 'true'
  cache-key-suffix:
    description: "Bump to bust APT cache"
    required: false
    default: 'v1'

runs:
  using: "composite"
  steps:
    - name: Prep APT cache
      if: inputs.apt-cache == 'true'
      uses: actions/cache@v4
      with:
        path: |
          ~/.apt-cache/archives
          ~/.apt-cache/lists
        key: ${{ runner.os }}-apt-riscv-${{ inputs.cache-key-suffix }}
        restore-keys: |
          ${{ runner.os }}-apt-riscv-

    - name: Install toolchain and QEMU
      shell: bash
      run: |
        set -euxo pipefail
        
        echo 'set man-db/auto-update false' | sudo debconf-communicate
        sudo rm -f /var/lib/man-db/auto-update || true
        
        if [[ -d "$HOME/.apt-cache/archives" ]]; then
          sudo apt-get -o Dir::Cache::archives="$HOME/.apt-cache/archives" \
                       -o Dir::State::lists="$HOME/.apt-cache/lists" update
          sudo apt-get -o Dir::Cache::archives="$HOME/.apt-cache/archives" \
                       -o Dir::State::lists="$HOME/.apt-cache/lists" \
                       install -y --no-install-recommends \
                       build-essential make python3 ca-certificates \
                       gcc-riscv64-unknown-elf binutils-riscv64-unknown-elf \
                       qemu-system-misc
        else
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
               build-essential make python3 ca-certificates \
               gcc-riscv64-unknown-elf binutils-riscv64-unknown-elf \
               qemu-system-misc
        fi

    # expose bundled headers without checking out anything in the main repo
    - name: Export CPATH to bundled headers
      shell: bash
      run: |
        # $GITHUB_ACTION_PATH points to this action folder
        echo "CPATH=${GITHUB_ACTION_PATH}/include:${CPATH:-}" >> "$GITHUB_ENV"
